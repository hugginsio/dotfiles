#!/usr/bin/env python
# vim: ft=python

import argparse
import json
import subprocess

parser = argparse.ArgumentParser(
    prog="zk-new-work-item",
    description="Create a new work item note via `zk` with details from `az`.",
)

parser.add_argument(
    "notebook",
    help="Notebook directory from `zk` ($ZK_NOTEBOOK_DIR)",
    type=str,
)

parser.add_argument(
    "identifier",
    help="The work item identifier",
    type=int,
)

args = parser.parse_args()

# TODO: check for error with az

azOutput = subprocess.run(
    [
        "az",
        "boards",
        "work-item",
        "show",
        "--id",
        str(args.identifier),
        "--org",
        "https://dev.azure.com/jbhunt/",
        "--output",
        "json",
    ],
    stdout=subprocess.PIPE,
)

azJson = json.loads(azOutput.stdout.decode("utf-8"))
# TODO: validate fields is present before continuing
jsonFields = azJson["fields"]

application = jsonFields.get("Custom.Repository", "")
installDate = jsonFields.get("JBH.InstallDate", "")
state = str(jsonFields["System.BoardColumn"]).lower().replace(" ", "-")
workItemTitle = jsonFields["System.Title"]

extras = "application=%s,install-date=%s,state=%s,work-item-title=%s,work-item=%s" % (
    application,
    installDate,
    state,
    workItemTitle,
    args.identifier,
)

print("Adding work item %d to notebook:" % (args.identifier))
print(extras)

# zk new --no-input "$argv[2]/work-item" --title="$argv[1]" --extra=$extras
