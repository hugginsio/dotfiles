#!/usr/bin/env python
# vim: ft=python

import argparse
import json
import subprocess
import sys

parser = argparse.ArgumentParser(
    prog="zk-new-work-item",
    description="Create a new work item note via `zk` with details from `az`.",
)

parser.add_argument(
    "notebook",
    help="Notebook directory from `zk` ($ZK_NOTEBOOK_DIR)",
    type=str,
)

parser.add_argument(
    "identifier",
    help="The work item identifier",
    type=int,
)

args = parser.parse_args()

azOutput = subprocess.run(
    [
        "az",
        "boards",
        "work-item",
        "show",
        "--id",
        str(args.identifier),
        "--org",
        "https://dev.azure.com/jbhunt/",
        "--output",
        "json",
    ],
    stdout=subprocess.PIPE,
    check=True,
)

azJson = json.loads(azOutput.stdout.decode("utf-8"))

if "fields" not in azJson:
    print("Could not get work item details from Azure CLI.")
    sys.exit(5)

jsonFields = azJson["fields"]

application = jsonFields.get("Custom.Repository", "")
installDate = jsonFields.get("JBH.InstallDate", "")
state = str(jsonFields["System.BoardColumn"]).lower().replace(" ", "-")
workItemTitle = jsonFields["System.Title"]

extras = "application=%s,install-date=%s,state=%s,work-item-title=%s,work-item=%s" % (
    application,
    installDate,
    state,
    workItemTitle,
    args.identifier,
)

print("Adding work item %d to notebook:" % (args.identifier))
print(extras)

subprocess.run(
    [
        "zk",
        "new",
        "--no-input",
        "%s/work-item" % args.notebook,
        "--title",
        workItemTitle,
        "--extra",
        extras,
    ]
)
